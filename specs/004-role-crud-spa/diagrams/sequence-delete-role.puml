@startuml sequence-delete-role
!theme plain

title Sequence: Delete Role (US5 - P5)

actor User as user
participant "Browser" as browser
participant "AppComponent" as app
participant "confirm()" as confirm
participant "HttpClient" as http
participant "nginx" as nginx
participant "Backend API" as api
database "PostgreSQL" as db

user -> browser: Click "Delete" on role row
activate browser

browser -> app: deleteRole(roleId)
activate app

app -> confirm: confirm("Delete this role?")
activate confirm

confirm --> user: Show browser confirm dialog

alt User cancels
    user -> confirm: Cancel
    confirm --> app: false
    deactivate confirm
    app --> user: No action taken
else User confirms
    user -> confirm: OK
    confirm --> app: true
    deactivate confirm

    app -> http: DELETE /roles/{id}
    activate http

    http -> nginx: DELETE /roles/{id}
    activate nginx

    nginx -> api: DELETE /roles/{id} (proxy)
    activate api

    api -> db: SELECT EXISTS(id)
    activate db
    db --> api: exists (boolean)
    deactivate db

    alt Role not found
        api --> nginx: 404 Not Found
        nginx --> http: 404 Not Found
        http --> app: Error
        app --> user: Show "Role not found" error
    else Role found
        api -> db: Check if role assigned to users
        activate db
        db --> api: user_count
        deactivate db

        alt Role is assigned to users
            api --> nginx: 400/409 {error: "Cannot delete role: role is assigned to users"}
            deactivate api
            nginx --> http: Error response
            deactivate nginx
            http --> app: Error
            deactivate http
            app -> app: Extract error message from response
            app --> user: Show "Cannot delete role: role is assigned to users"
        else Role is not assigned
            api -> db: DELETE FROM roles WHERE id = ?
            activate db
            db --> api: OK
            deactivate db

            api --> nginx: 204 No Content
            deactivate api

            nginx --> http: 204 No Content
            deactivate nginx

            http --> app: void
            deactivate http

            app -> app: showSuccess("Role deleted")
            app -> app: loadRoles() [refresh table]
            app --> user: Updated table + success message
        end
    end
end

deactivate app
deactivate browser

note over api
    Backend constraint:
    Cannot delete role if
    assigned to any users
    Returns descriptive error
end note

@enduml
